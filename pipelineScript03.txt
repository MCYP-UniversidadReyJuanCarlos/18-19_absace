pipeline {
	agent any
	environment {
		//Variables de entorno
		workspace = pwd()
	}
	tools { 
		maven 'maven363'
		//'org.jenkinsci.plugins.docker.commons.tools.DockerTool' 'dockerJenkins'
	}
	stages {
		stage('Checkout repository changes') {
			steps {
				echo 'Downloading the code from GitHub'
				checkout([$class: 'GitSCM', branches: [[name: '*/develop']],
				doGenerateSubmoduleConfigurations: false, extensions: [],
				submoduleCfg: [], userRemoteConfigs: [[url: 'https://github.com/Abrin09/WebGoat.git']]])
			}
		}
		stage('SAST analysis') {
			steps {
				echo 'Performing SAST analysis to the code from the commit'
				sh "/var/jenkins_home/tools/hudson.plugins.sonar.SonarRunnerInstallation/SonarQubeScanner/bin/sonar-scanner -X -Dsonar.host.url=http://34.245.15.238:9000/ -Dsonar.projectKey=webgoat -Dsonar.projectName=webgoat -Dsonar.projectVersion=1.0 -Dsonar.java.binaries=. -Dsonar.exclusions=**/*.ts"
				echo 'SAST Finished!!!'
			}
		}
		stage('Docker Build') {
			steps {
				echo 'Compiling Code'
				sh "mvn clean install -DskipTests"
				echo 'Compilated Code Succesful'
				echo 'Building docker image'
				sh "docker build -t webgoat-abrin09:${env.BUILD_ID} ./webgoat-server"
				echo 'Docker image builded'
			}
		}
		stage('Dependency analysis') {
			steps {
				echo 'Performing Code Dependency analysis from the commit'
				dependencyCheck additionalArguments: '', odcInstallation: 'dependencyCheckOWASP'
				//dependencyCheckAnalyzer datadir: 'dependency-check-data', hintsFile: '', includeCsvReports: false, includeHtmlReports: true, includeJsonReports: true, includeVulnReports: true, isAutoupdateDisabled: false, outdir: '.', scanpath: '', skipOnScmChange: false, skipOnUpstreamChange: false, suppressionFile: '', zipExtensions: ''
				echo 'Finished!!!'
				dependencyCheckPublisher pattern: 'dependency-check-report.xml'
				echo 'Publishing results...'
			}
		}
	}
}
